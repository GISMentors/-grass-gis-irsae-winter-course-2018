Unit 17 - Lidar scripting
=========================

In this unit we will recover our knowledge of PyGRASS scripting (see
:doc:`14`). Let's create a fancy script to produce seamless DEM
(Digital Elevation Model) from bunch of LAS/LAZ files. Why so fancy?
We will do our work in parallel!

Let's start with defining user interface. There will be one input:

* :param:`directory` (line :lcode:`6`) - directory with input LAS/LAZ files

and one output:

* :param:`elevation` (line :lcode:`9`) - name for output elevation raster map mosaics

The resolution of output DEM will be defined by :param:`resolution`
parameter (line :lcode:`13`). And finally user will be able to control
number of processes running in parallel by :param:`nproc` (line :lcode:`18`).

Our script consists of three main functions:

1. ``import_files()`` to import input LAS/LAZ files (line
:lcode:`33`). Import process can be done in parallel by
:pygrass-modules:`ParallelModuleQueue`, see lines :lcode:`37, 42, 56,
57, 59`.

2. ``create_dem_tiles()`` to compute DEM per tile (line :lcode:`66`)
using :grasscmd:`v.surf.rst`. We need to compute DEMs with reasonable
overlap in order to create seamless mosaics, see
:lcode:`72-75`. Tiles can be processed in parallel too, see line
:lcode:`81`.

3. ``patch_tiles()`` to patch DEM tiles together by
:grasscmd:`r.series`, see :lcode:`88`. In overlaps cell values will be
computed as average, it is a main reason why we do not use
:grasscmd:`r.patch`.

.. literalinclude:: ../_static/scripts/create-dem.py
   :language: python
   :linenos:
   :emphasize-lines: 6, 9, 13, 18, 33, 37, 42, 56, 57, 59, 66, 72-75, 81, 88

.. note::

	The script is tacking long time with all the tiles in the 
	:file:`/home/geodata/lidar/laz/`
	
.. tip::
	
	Create a new directory like :file:`/tmp/lidar` and link some (2 or 3) of the LAZ
	files with
	
	.. code ::
		
		ln -s /home/geodata/lidar/laz/32-1-514-136-15.laz /tmp/lidar/

	Use :file:`/tmp/lidar` as :option:`input` in the :file:`create-dem.py` script
	
.. figure:: ../images/units/17/dsm_patched.png
   :class: middle
   
   The DSM created from all tiles

Compare with existing raster
----------------------------

First we need to import all the DTM downloaded from
`hoydedata.no <http://www.hoydedata.no/>`__. You can import all TIF file
using :menuselection:`File --> Import raster data --> Simplified raster
import with reprojection` checking :item:`Directory` as :item:`Source type`
and selecting :file:`/home/geodata/lidar/dtm/`

.. figure:: ../images/units/17/import_dtm.png
   :class: middle
   
   Import all DTM from :file:`/home/geodata/lidar/dtm/`

.. note::

   In your case select only the tiles selected before

Once the DTM are imported you can patch them using :grasscmd:`r.series`
and set the color to `elevation`

.. code-block:: bash

   r.series input=`g.list type=raster pattern=DTM_* sep=','` output=DTM_patch
   r.colors map=DTM_patch@lidar color=elevation

.. figure:: ../images/units/17/dtm_patched.png
   :class: middle
   
   The patched DTM

The last step is to calculate the difference beetween the imported DTM and
the created DSM, using :grasscmd:`r.mapcalc`

.. code-block:: bash

   r.mapcalc expression="chm = new_ele - DTM_patch"

.. figure:: ../images/units/17/chm.png
   :class: middle
   
   The CHM map (difference between DSM and DTM)
